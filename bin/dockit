#!/bin/sh

while getopts ":dm:r:" opt
do
    case $opt in
        d)
            detach=true
            ;;
        m)
            mount_as=$OPTARG
            ;;
        r)
            run_as=$OPTARG
            ;;
        \?)
            echo "Unrecognized option: -$OPTARG"
            exit 1
            ;;
        :)
            echo "-$OPTARG requires an argument" 1>&2
            exit 1
            ;;
    esac
done
shift $(($OPTIND-1))

img=$1
docker pull $img 1>&2

user=$(docker image inspect $img --format "{{.ContainerConfig.User}}")

if [ -z "$mount_as" ]
then
    if [ "$user" ]
    then
        mount_as="$user"
    else
        mount_as="root"
    fi
fi

if [ -z "$run_as" ]
then
    if [ "$user" ]
    then
        run_as=$user
    else
        run_as="root"
    fi
fi

scriptdir="$(dirname "$0")"
lib="$(cd $scriptdir/../lib ; pwd)/dockit"

docker run \
    --rm \
    -u 0:0 \
    --privileged \
    -ti \
    ${detach:+-d} \
    -v $lib/init:/dockit-init \
    -v $lib/undock:/bin/undock \
    -v $(pwd):/host \
    $img \
    /dockit-init -m $mount_as -r $run_as
