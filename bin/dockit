#!/bin/sh

while getopts ":da:" opt
do
    case $opt in
        d)
            detach=true
            shift
            ;;
        a)
            mount_as=$OPTARG
            shift 2
            ;;
        \?)
            echo "Unrecognized option: -$OPTARG"
            exit 1
            ;;
        :)
            echo "-$OPTARG requires an argument" 1>&2
            exit 1
            ;;
    esac
done

if [ -z "$mount_as" ]
then
    mount_as="$(id -u):$(id -g)"
fi

img=$1
docker pull $img 1>&2

scriptdir="$(dirname "$0")"
lib="$(cd $scriptdir/../lib ; pwd)/dockit"

docker run \
    --rm \
    --privileged \
    -ti \
    ${detach:+-d} \
    -v $lib/init:/dockit-init \
    -v $lib/undock:/bin/undock \
    -v $(pwd):/host \
    $img \
    /dockit-init -a $mount_as
